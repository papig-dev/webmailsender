{% extends "base.html" %}

{% block title %}{{ '템플릿 편집' if template else '새 템플릿 생성' }} - 웹메일 발송 시스템{% endblock %}

{% block content %}
<div class="page-header d-print-none">
    <div class="row align-items-center">
        <div class="col">
            <h2 class="page-title">
                <i class="fa fa-file-text-o"></i>
                {{ '템플릿 편집' if template else '새 템플릿 생성' }}
            </h2>
        </div>
        <div class="col-auto ms-auto d-print-none">
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                <i class="fa fa-arrow-left"></i>
                목록으로
            </a>
        </div>
    </div>
</div>

<form method="POST" action="{{ url_for('save_template_route') }}">
    <input type="hidden" name="template_id" value="{{ template_id if template else '' }}">

    <div class="row row-cards">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">기본 정보</h3>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label class="form-label">
                                <i class="fa fa-header"></i>
                                템플릿 제목
                            </label>
                            <input type="text" name="title" required value="{{ template.title if template else '' }}" class="form-control" placeholder="템플릿 제목을 입력하세요">
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label">
                                <i class="fa fa-envelope"></i>
                                메일 제목
                            </label>
                            <input type="text" name="subject" required value="{{ template.subject if template else '' }}" class="form-control" placeholder="메일 제목을 입력하세요">
                        </div>
                        <div class="col-12">
                            <label class="form-label">
                                <i class="fa fa-user"></i>
                                발신자 이메일
                            </label>
                            <input type="email" name="from_email" value="{{ template.from_email if template else '' }}" class="form-control" placeholder="sender@example.com (비워두면 설정의 발신자 이메일 사용)">
                            <div class="form-hint">
                                <i class="fa fa-info-circle"></i>
                                이 템플릿에만 사용할 발신자 이메일입니다. 비워두면 설정의 기본 발신자 이메일을 사용합니다.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fa fa-picture-o"></i>
                        인라인 이미지 (CID)
                    </h3>
                </div>
                <div class="card-body">
                    {% if template %}
                        <div class="row g-3 align-items-end">
                            <div class="col-12 col-md-4">
                                <label class="form-label">CID 이름</label>
                                <input id="cidName" type="text" class="form-control" placeholder="image1">
                            </div>
                            <div class="col-12 col-md-5">
                                <label class="form-label">이미지 파일</label>
                                <input id="cidFile" type="file" class="form-control" accept="image/*">
                            </div>
                            <div class="col-12 col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-primary w-100" onclick="uploadCidImage()">
                                    <i class="fa fa-upload"></i>
                                    업로드
                                </button>
                            </div>
                        </div>

                        <div class="form-hint mt-2">본문에서 <code>src=&quot;cid:image1&quot;</code> 처럼 사용합니다.</div>

                        <div class="mt-4">
                            <div class="table-responsive">
                                <table class="table table-vcenter">
                                    <thead>
                                        <tr>
                                            <th>CID</th>
                                            <th>파일명</th>
                                            <th>미리보기</th>
                                            <th class="w-1"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="assetRows">
                                        <tr>
                                            <td colspan="4" class="text-secondary">로딩 중...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-secondary">먼저 템플릿을 저장한 후(템플릿 ID 생성) 인라인 이미지를 업로드할 수 있습니다.</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fa fa-code"></i>
                        HTML 내용
                    </h3>
                    <div class="card-actions">
                        <div class="btn-list">
                            <button type="button" onclick="toggleView()" class="btn btn-outline-secondary btn-sm">
                                <i class="fa fa-external-link"></i>
                                새 창 미리보기
                            </button>
                            <button type="button" onclick="insertSampleTemplate()" class="btn btn-success btn-sm">
                                <i class="fa fa-magic"></i>
                                샘플 템플릿
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="editor-container">
                        <textarea name="html_content" id="html-editor" style="display:none;">{{ template.html_content if template else '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fa fa-users"></i>
                        기본 수신자
                    </h3>
                </div>
                <div class="card-body">
                    <label class="form-label">기본 수신자 목록 (한 줄에 하나씩)</label>
                    <textarea name="recipients" rows="4" class="form-control" placeholder="example1@email.com&#10;example2@email.com&#10;example3@email.com">{{ '\n'.join(template.recipients) if template else '' }}</textarea>
                    <div class="form-hint mt-2">
                        <i class="fa fa-info-circle"></i>
                        여기에 입력된 수신자는 발송 시 기본으로 표시되며, 수정 가능합니다.
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="d-flex justify-content-end gap-2">
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">취소</a>
                <button type="submit" class="btn btn-primary">
                    <i class="fa fa-save"></i>
                    저장
                </button>
            </div>
        </div>
    </div>
</form>

<script>
    let editor;
    let isPreviewMode = false;

    // CodeMirror 초기화
    document.addEventListener('DOMContentLoaded', function() {
        editor = CodeMirror.fromTextArea(document.getElementById('html-editor'), {
            mode: 'htmlmixed',
            theme: 'monokai',
            lineNumbers: true,
            lineWrapping: true,
            autoCloseTags: true,
            autoCloseBrackets: true
        });

        // 에디터 내용 변경 시 미리보기 업데이트
        editor.on('change', function() {
            if (isPreviewMode) {
                updatePreview();
            }
        });

        // 초기 상태는 에디터
        document.getElementById('html-editor').parentElement.style.display = 'block';
        const previewContainer = document.getElementById('preview-container');
        if (previewContainer) {
            previewContainer.style.display = 'none';
        }
        
        // 템플릿이 있으면 초기 내용 설정
        if (editor.getValue().trim() === '') {
            const initialContent = document.querySelector('textarea[name="html_content"]').value;
            if (initialContent) {
                editor.setValue(initialContent);
            }
        }

        const templateId = `{{ template_id if template else '' }}`;
        if (templateId) {
            loadAssets();
        }

        const fileInput = document.getElementById('cidFile');
        if (fileInput) {
            fileInput.addEventListener('change', function() {
                const cidInput = document.getElementById('cidName');
                const current = (cidInput?.value || '').trim();
                if (current) return;

                const file = fileInput.files?.[0];
                if (!file) return;

                const name = file.name || '';
                const stem = name.replace(/\.[^/.]+$/, '');
                const suggested = stem.replace(/[^a-zA-Z0-9_.-]+/g, '_').replace(/^_+|_+$/g, '');
                if (cidInput && suggested) {
                    cidInput.value = suggested;
                }
            });
        }
    });

    async function loadAssets() {
        const templateId = `{{ template_id if template else '' }}`;
        if (!templateId) return;

        const tbody = document.getElementById('assetRows');
        if (!tbody) return;

        try {
            const res = await fetch(`/template/${templateId}/assets`);
            const data = await res.json();
            const assets = data.assets || [];

            if (assets.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-secondary">업로드된 이미지가 없습니다.</td></tr>`;
                return;
            }

            tbody.innerHTML = assets.map(a => {
                const cid = a.cid || '';
                const filename = a.filename || '';
                const imgUrl = `/template/${templateId}/assets/view/${encodeURIComponent(cid)}`;
                return `
                    <tr>
                        <td><code>cid:${cid}</code></td>
                        <td class="text-secondary">${filename}</td>
                        <td>
                            <img src="${imgUrl}" alt="${cid}" style="max-height: 44px; max-width: 120px;" class="rounded border" />
                        </td>
                        <td>
                            <div class="btn-list flex-nowrap">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="copyCid('${cid}')">
                                    <i class="fa fa-copy"></i>
                                    복사
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteCid('${cid}')">
                                    <i class="fa fa-trash"></i>
                                    삭제
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        } catch (e) {
            tbody.innerHTML = `<tr><td colspan="3" class="text-danger">목록 로딩 실패</td></tr>`;
        }
    }

    async function uploadCidImage() {
        const templateId = `{{ template_id if template else '' }}`;
        if (!templateId) return;

        const cidName = (document.getElementById('cidName')?.value || '').trim();
        const fileInput = document.getElementById('cidFile');
        const file = fileInput?.files?.[0];

        if (!file) {
            showAlert('업로드할 파일을 선택해주세요.', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        if (cidName) formData.append('cid', cidName);

        try {
            const res = await fetch(`/template/${templateId}/assets/upload`, { method: 'POST', body: formData });
            const data = await res.json();
            if (!res.ok) {
                showAlert(data.error || '업로드에 실패했습니다.', 'error');
                return;
            }
            showAlert(`업로드 완료: cid:${data.cid}`, 'success');
            document.getElementById('cidName').value = '';
            fileInput.value = '';
            await loadAssets();
        } catch (e) {
            showAlert('업로드 중 오류가 발생했습니다.', 'error');
        }
    }

    async function deleteCid(cid) {
        const templateId = `{{ template_id if template else '' }}`;
        if (!templateId) return;

        if (!confirm(`삭제하시겠습니까? (cid:${cid})`)) return;

        const formData = new FormData();
        formData.append('cid', cid);

        try {
            const res = await fetch(`/template/${templateId}/assets/delete`, { method: 'POST', body: formData });
            const data = await res.json();
            if (!res.ok) {
                showAlert(data.error || '삭제에 실패했습니다.', 'error');
                return;
            }
            showAlert('삭제 완료', 'success');
            await loadAssets();
        } catch (e) {
            showAlert('삭제 중 오류가 발생했습니다.', 'error');
        }
    }

    async function copyCid(cid) {
        const text = `cid:${cid}`;
        try {
            await navigator.clipboard.writeText(text);
            showAlert(`복사됨: ${text}`, 'success');
        } catch (e) {
            alert(text);
        }
    }

    function toggleView() {
        // 그냥 미리보기 새 창 열기
        updatePreview();
    }

    function updatePreview() {
        // 새 창으로 미리보기
        const htmlContent = editor.getValue();
        const templateId = `{{ template_id if template else '' }}`;
        let previewHtml = htmlContent;

        if (templateId) {
            previewHtml = previewHtml.replace(/cid:([a-zA-Z0-9_.-]+)/g, `/template/${templateId}/assets/view/$1`);
        }
        
        if (previewHtml.trim()) {
            const previewWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
            previewWindow.document.write(previewHtml);
            previewWindow.document.close();
            console.log('Preview opened in new window');
        } else {
            alert('HTML 내용이 없습니다.');
        }
    }

    function insertSampleTemplate() {
        const sampleTemplate = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>샘플 메일</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background-color: #f4f4f4;
            padding: 20px;
            text-align: center;
            border-radius: 5px;
        }
        .content {
            padding: 20px 0;
        }
        .footer {
            background-color: #f4f4f4;
            padding: 20px;
            text-align: center;
            border-radius: 5px;
            margin-top: 20px;
        }
        .button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>샘플 메일 제목</h1>
    </div>
    
    <div class="content">
        <h2>안녕하세요!</h2>
        <p>이것은 샘플 이메일 템플릿입니다. 원하는 내용으로 자유롭게 수정하세요.</p>
        <p>HTML 태그를 사용하여 다양한 스타일을 적용할 수 있습니다.</p>
        
        <h3>주요 특징</h3>
        <ul>
            <li>HTML 편집기 지원</li>
            <li>실시간 미리보기</li>
            <li>다중 수신자 발송</li>
            <li>발송 결과 추적</li>
        </ul>
        
        <div style="text-align: center; margin: 30px 0;">
            <a href="#" class="button">자세히 보기</a>
        </div>
    </div>
    
    <div class="footer">
        <p>감사합니다.<br>웹메일 발송 시스템</p>
    </div>
</body>
</html>`;
        
        editor.setValue(sampleTemplate.trim());
        if (isPreviewMode) {
            updatePreview();
        }
    }
</script>
{% endblock %}
